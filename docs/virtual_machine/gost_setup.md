# Syndicate Setup

The system is designed to run autonomously, with features for intelligent scheduling, multi-provider LLM fallback, and rich integration with Notion for report publishing.

## 1. Application Setup

The application is built with Python and relies on a virtual environment for dependency management.

### Requirements

- Python 3.10 - 3.13
- Git

### Setup Steps

The project includes automated setup scripts for both Windows and Unix-like systems:

- **Windows**: `setup.ps1`
- **Unix/macOS/Linux**: `setup.sh`

These scripts handle:
- Creation and activation of a Python virtual environment.
- Installation of all required dependencies from `requirements.txt` and `requirements-dev.txt`.
- Creation of a `.env` file from the `.env.template` for storing API keys and other secrets.
- Initialization of the Cortex memory.

### Configuration

The application is configured through a `.env` file in the project's root directory. This file is used to store sensitive information like API keys:

- `GEMINI_API_KEY`: For Google Gemini AI services.
- `NOTION_API_KEY`: For Notion integration.
- `NOTION_DATABASE_ID`: The ID of the Notion database to publish reports to.
- `IMGBB_API_KEY`: For hosting chart images.

## 2. Systemd Automations

The project uses `systemd` services and timers to automate its operations.

### 2.1. `syndicate-compose.service`

This service manages the Docker Compose stack for the project.

- **Description**: "Syndicate Docker Compose Stack"
- **User**: `root`
- **Dependencies**: Requires `docker.service` and `network-online.target`.
- **Function**:
    - Starts the Docker Compose stack with the `monitoring` and `logging` profiles in detached mode (`docker-compose --profile monitoring --profile logging up -d`).
    - Stops the stack when the service is stopped.
- **Behavior**:
    - Starts on system boot (`WantedBy=multi-user.target`).
    - Restarts automatically on failure after a 5-second delay.

### 2.2. `syndicate-daily.service` & `syndicate-daily.timer`

This service and timer pair are responsible for the daily analysis runs.

- **Service (`syndicate-daily.service`)**:
    - **Description**: "Syndicate Daily Analysis Trigger"
    - **User**: `user`
    - **Command**: `/usr/bin/flock -n /tmp/syndicate.lock /home/user/codex.sh run`
        - The `flock` command ensures that only one instance of the daily analysis can run at a time.
        - The `/home/user/codex.sh run` script is the entry point for the daily analysis.
    - **Logging**: All output is logged to `/home/user/syndicate_config/run.log`.

- **Timer (`syndicate-daily.timer`)**:
    - **Description**: "Run Syndicate Daily Analysis at 5am"
    - **Schedule**: Runs daily (`OnCalendar=daily`).
    - **Behavior**:
        - The job is started with a random delay of up to 30 minutes to avoid resource contention.
        - If a scheduled run is missed (e.g., due to the system being powered off), it will be triggered as soon as the system is back online (`Persistent=true`).

### 2.3. `syndicate-weekly-cleanup.service` & `syndicate-weekly-cleanup.timer`

This service and timer pair handle the weekly cleanup tasks.

- **Service (`syndicate-weekly-cleanup.service`)**:
    - **Description**: "Syndicate Weekly Cleanup"
    - **Dependencies**: Requires `docker.service` and `network-online.target`.
    - **Command**: `/usr/local/bin/syndicate-weekly-cleanup.sh`
    - **Logging**: All output is logged to `/home/user/syndicate_config/cleanup.log`.

- **Timer (`syndicate-weekly-cleanup.timer`)**:
    - **Description**: "Run Syndicate Weekly Cleanup at 1am on Sunday"
    - **Schedule**: Runs weekly (`OnCalendar=weekly`).

## 3. Docker and Data Storage

The project uses Docker Compose to manage its services, including the main application and a monitoring stack.

### High-Importance: Data Storage

**A critical requirement is that no Docker data is stored on the root filesystem.** The root filesystem of the VM is small and should not be used for persistent application data.

To enforce this, the `docker-compose.yml` file has been configured to use **bind mounts** to a dedicated directory on a separate data disk (`/mnt/newdisk`). All persistent data generated by the Docker containers is stored in the `/mnt/newdisk/syndicate/docker-data` directory.

This approach ensures that Docker volumes do not consume space on the root filesystem, preventing potential disk space issues and preserving the stability of the VM.

### Docker Compose Services

The `docker-compose.yml` file defines the following services:

- **`gost`**: The main Syndicate application.
- **`prometheus`**: For metrics collection.
- **`grafana`**: For visualization and dashboards.
- **`alertmanager`**: For alert routing.
- **`node-exporter`**: For host system metrics.
- **`cadvisor`**: For container metrics.
- **`loki`**: For log aggregation.
- **`promtail`**: For log collection.
- **`gost-dev`**: A development container.

### Volume Configuration

The `docker-compose.yml` file has been modified to use bind mounts for all persistent data. Instead of using Docker's default named volumes (which are stored on the root filesystem), each service now mounts a subdirectory within `/mnt/newdisk/syndicate/docker-data`.

For example, the `gost` service's volumes are configured as follows:

```yaml
        volumes:
            # Persistent data
            - ./docker-data/gost_data:/app/data
            - ./docker-data/gost_output:/app/output
            # Configuration (optional mount)
            - ./cortex_memory.json:/app/cortex_memory.json:ro
```

This ensures that all application data, monitoring data, and logs generated by the Docker stack are stored on the data disk, as required.

---

# Command Reference

> `codex.sh` is a utility script designed to simplify interaction with the Syndicate Docker Compose project. It provides a set of high-level commands to manage the project's lifecycle, including running analysis, monitoring logs, and building services.

## Usage

```
/home/user/codex.sh {command}
```

## Commands

| Command | Description |
| :------ | :---------- |
| `run`   | Execute the `syndicate` project for a single analysis cycle, including post-analysis tasks and Notion publishing. This is a one-shot operation suitable for `systemd` timers. |
| `monitor` | Monitor the real-time logs of the main `gost` service. |
| `status` | Show the status of the docker compose services. |
| `stop`  | Stop the docker compose services. |
| `build` | Rebuild the Docker image(s) for the `syndicate` project. This ensures that any changes to the application code or Dockerfile are incorporated. |
| `heal`  | Stop and restart the Docker Compose services engine (monitoring and logging profiles). This helps to bring services back to a healthy state. |
| `help`  | Display this help message. |

## Configuration

*   **`DOCKER_COMPOSE_FILE`**: `/mnt/newdisk/syndicate/docker-compose.yml`
*   **`SERVICE_NAME`**: `gost` (the main Syndicate application service)

This script ensures that necessary environment variables are loaded from `.env` and that Docker commands run with appropriate user permissions.
