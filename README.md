# Gold Standard 
> Quant Analysis —

## Technical Overview
![Python Version](https://img.shields.io/badge/python-3.11%2B-blue)
![License](https://img.shields.io/badge/license-MIT-green)
![CI](https://github.com/amuzetnoM/gold_standard/actions/workflows/python-ci.yml/badge.svg)
![Codecov](https://img.shields.io/codecov/c/gh/amuzetnoM/gold_standard)
![Pre-commit](https://results.pre-commit.ci/badge/github/amuzetnoM/gold_standard/main.svg)

## Example Charts (generated)
Below are a few sample charts generated by the pipeline to illustrate the default outputs you can expect. These are included for demonstration and quick onboarding; your own runs will generate new charts in `output/charts/`.

<table>
  <tr>
    <td align="center"><b>Gold</b><br/><img src="docs/images/GOLD.png" alt="Gold Chart" width="360"></td>
    <td align="center"><b>Silver</b><br/><img src="docs/images/SILVER.png" alt="Silver Chart" width="360"></td>
    <td align="center"><b>Dollar Index</b><br/><img src="docs/images/DXY.png" alt="Dollar Index Chart" width="360"></td>
    <td align="center"><b>VIX</b><br/><img src="docs/images/VIX.png" alt="VIX Chart" width="360"></td>
  </tr>
</table>


Badges (what they mean):
- CI: GitHub Actions test and lint status for the default branch.
- Codecov: Test coverage aggregated for the repository (requires Codecov setup to show data).
- Pre-commit: Status of `pre-commit.ci` and hooks for the repository (optional, requires configuration).

Welcome to Gold Standard — an end-to-end quantitative analysis pipeline focused on gold and its intermarket relationships, producing structured AI-enhanced market reports.

This README provides an exhaustive technical overview of the repository and how each module operates. A separate companion `BOOKLET.md` provides a conceptual primer and tutorial for newcomers wanting to understand the math, architecture, and operational best practices.

Table of contents
* Quickstart
* Architecture & Module Deep Dive
* Modules at a glance
* Data Pipeline Details
* Technical Indicators & Fallbacks
* Secrets Management & Pre-commit Hooks
* Development, Tests, and CI Recommendations
* Troubleshooting & Operational Notes
* Contributing & Future Work
* Appendices
  - Cortex (Memory & Reflection)
  - QuantEngine (Market Data, Indicators & Charts)
  - Strategist (AI Analysis & Bias Extraction)
  - Execution Loop & Scheduling
- Data Pipeline Details
- Technical Indicators & Fallbacks
- Logging, File Locking & Concurrency
- Secrets Management & Pre-commit Hooks
- Development, Tests, and CI Recommendations
- Troubleshooting & Operational Notes
- Contributing & Future Work
- Appendices

---

Quickstart

1) Create local virtual environment and install dependencies:

   PowerShell (Windows):
   ```powershell
   python -m venv .venv
   .\.venv\Scripts\Activate.ps1
   python -m pip install -r requirements.txt
   python -m pip install -r requirements-dev.txt  # for tests & pre-commit
   ```

   Unix (macOS / Linux):
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   pip install -r requirements-dev.txt
   ```

2) Prepare environment variables:
  - Copy the included `.env.template` to `.env`, then fill in your credentials. Do NOT commit your `.env` file to source control.
  ```powershell
  cp .env.template .env
  # Edit .env and set GEMINI_API_KEY
  ```
  - Alternatively, export key(s) in your session if not using a `.env` file.
  - `python-dotenv` will automatically load `.env` when running `python main.py`.

3) Local test run (no AI; quick):
   ```bash
   python main.py --once --no-ai
   ```

4) Run with AI (requires `GEMINI_API_KEY`):
   ```bash
   python main.py --once
   ```

Output will be under `output/` with charts in `output/charts` and a markdown journal `Journal_YYYY-MM-DD.md`.

Key files:
| File | Purpose |
|---|---|
| `main.py` | Core pipeline and CLI entry point (Cortex, QuantEngine, Strategist) |
| `cortex_memory.template.json` | Safe default memory template for new users |
| `scripts/init_cortex.py` | Helper to initialize local `cortex_memory.json` from template |
| `scripts/prevent_secrets.py` | Pre-commit helper that blocks committing `.env` and likely secrets |
| `output/charts` | Default destination for generated charts |
| `output/Journal_YYYY-MM-DD.md` | Generated report file for each run |

Why this project:
- Provides an automated, reproducible approach for intermarket analysis focused on precious metals and related assets.
- Combines well-known technical indicators with AI-generated natural language analysis to speed up research and journaling.

How to extend:
1. Add a new asset in `ASSETS` in `main.py`.
2. Extend `QuantEngine._fetch` to compute additional indicators.
3. Add plotting in `QuantEngine._chart` and validate output.
4. Add unit tests under `tests/` and fixtures under `tests/data/`.


---

Architecture & Module Deep Dive

This project is organized as a single-file application for convenience (`main.py`) but internally follows clear module responsibilities. For an at-a-glance summary, see the table below.

Modules at a glance
| Module | Purpose | Key methods |
|---|---|---|
| `Cortex` | Persistent memory of past predictions and grading performance | `_load_memory`, `update_memory`, `grade_performance`, `get_formatted_history` |
| `QuantEngine` | Fetch market data, compute indicators and generate charts | `get_data`, `_fetch`, `_chart`, `_cleanup_old_charts` |
| `Strategist` | Build prompts, call AI, and parse bias | `_build_prompt`, `think`, `_extract_bias` |
| `main()` & executors | Orchestrate runs, scheduling, and write reports | `execute`, scheduling loop and CLI handlers |


1) Cortex (Memory & Reflection)
   - Purpose: Persistent memory for the system. Records and persists the last bias, last price, history of the last N predictions, win/loss counters and streaks.
   - Storage: JSON file `cortex_memory.json` backed by `filelock.FileLock` to avoid corruption.
   - Primary functions:
     - `_load_memory()` merges defaults with a previously saved memory file.
     - `update_memory(bias, current_gold_price)` writes the latest bias and price to memory.
     - `grade_performance(current_gold_price)` compares current price with the last recorded price and updates win/loss counters.
     - `get_formatted_history()` formats memory for input into the AI prompt.
   - Notes:
     - The memory schema is intentionally simple and human-readable; you can add keys if you need more features.

2) QuantEngine (Market Data, Indicators & Charts)
   - Purpose: Fetch market data, compute indicators, build charts, and collect news headlines.
   - Data sources: `yfinance` is used to download OHLC Candle data. Each asset has a primary and backup ticker configuration (e.g., `GC=F` and `GLD` for Gold) in `ASSETS` map.
   - Indicators computed:
     - RSI (Relative Strength Index, period 14)
     - SMA (50 and 200)
     - ATR (Average True Range, period 14)
     - ADX (Average Directional Index; for trend detection)
   - Implementation note: `pandas_ta` is used for indicator calculations when available; if unavailable, a fallback implementation is used (safe monotonic approximations for SMA, RSI, ATR, ADX). The fallback is acceptable for analysis but not guaranteed to be numerically identical to `pandas_ta`/numba optimized code.
   - Charts: Generated using `mplfinance` and saved to `output/charts`. The project verifies charts are written and larger than a small size threshold to avoid empty/placeholder images.
   - News: `yfinance.Ticker(ticker).news` is polled when present for headline context.

3) Strategist (AI Analysis & Bias Extraction)
   - Purpose: Build a cleaned prompt from the quant data, pass it to Google Gemini, and parse the AI text for bias (BULLISH/BEARISH/NEUTRAL).
   - Input: The memory history, daily telemetry and ratios (e.g., Gold/Silver), and recently fetched news.
   - AI Integration: Uses `google.generativeai` with `GenerativeModel` to query a Gemini model (default `models/gemini-pro-latest`). The prompt includes explicit output rules and a markdown structure so the system can display the AI response in a structured journal.
   - Bias extraction: The code uses regex-based parsing of the AI response to detect explicit bias declarations. It also uses a fallback counting approach if the AI did not mark the bias explicitly.

4) Execution Loop & Scheduling
   - Entry: `main()` configures environmental variables (via `dotenv`), CLI args, logging, and the GenAI model.
   - Operation: `execute()` orchestrates a single run: fetch data, grade past predictions, run AI analysis, update memory, and write the report.
   - Scheduling: The default runs each hour via the `schedule` package; the number of hours can be overridden by `--interval`.
   - Graceful shutdown: SIGINT / SIGTERM are caught and the run will stop gracefully.

---

Data Pipeline Details & Safety
--------------------------------
This system attempts to avoid data issues by applying the following measures:
- Primary/Backup tickers for each asset so if a primary does not return usable OHLC, a backup is attempted.
- Drop NaN rows after indicator computation to only operate on clean, complete candle sets.
- File lock on memory file to prevent multiple running instances from interfering.

If you intend to run this on a VPS or in Docker, ensure a single instance is scheduled or use an external scheduler and a single memory store (e.g., S3) to avoid conflicts.

Technical Indicators & Fallbacks
- This project uses `pandas_ta` for convenience, but to support running on newer Python releases or in environments where `numba` isn't available, fallback implementations are provided. These fallbacks:
  - Compute SMA via rolling mean
  - Compute RSI via the gains/losses averaging method
  - Compute ATR as the rolling mean of true ranges
  - Provide a basic ADX implementation with DMI components
- Caveat: Fallback ADX is functional but may differ from `pandas_ta` / numba-based computations. For production-grade reliability, run this under Python 3.11 with `pandas_ta` and `numba` installed.

Logging, File Locking & Concurrency
- Logging is done via a root logger `GoldStandard` with:
  - A console handler (INFO) for real-time observability
  - A rotating file handler (5 MB max) writing to `output/gold_standard.log` for long-term diagnostics
- `filelock.FileLock` is used to protect `cortex_memory.json` (via `Cortex.lock`). This prevents concurrent main process runs from corrupting memory.

Secrets Management & Pre-commit Hooks
- Secrets should NEVER be committed to source control. The project contains a `.gitignore` entry for `.env` and `cortex_memory.json`.
- `pre-commit` is configured in `.pre-commit-config.yaml` and includes:
  - `black` formatting
  - `detect-secrets` checks
  - A local `prevent_secrets.py` script that blocks committing `.env` or other likely secret patterns
- If you accidentally commit a secret, rotate it immediately and remove it from your repo history (e.g., using `git filter-repo`).

Development, Tests, and CI Recommendations
- Use Python 3.11 for best compatibility with `pandas_ta` and `numba`.
- The repository includes `tests/test_core.py` (unit tests for bias parsing and fewer core functions). Run them with `pytest`.
 - Add a GitHub Actions workflow that:
  1. Uses the `python` virtual environment with 3.11.
  2. Installs dependencies from `requirements-dev.txt` and runs `pre-commit` and `pytest`.
  3. Checks linting and formatting rules with `black` and `flake8` if desired.

Sample GitHub Actions workflow (quick-start):
```yaml
name: Python CI
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: python -m pip install -r requirements-dev.txt
      - name: Run pre-commit
        run: pre-commit run --all-files
      - name: Run tests
        run: pytest -q --disable-warnings --maxfail=1
```

Troubleshooting & Operational Notes
- If `numba` fails to install on Python versions > 3.11, fallback logic will still run — but check numerical parity if you rely on ADX values.
- If Gemini fails with `model not found`, use `scripts/list_gemini_models.py` with your credentials to locate an accessible model.
- If chart generation fails or chart files are tiny, it likely indicates that the OHLC dataset is too small after NaN removal or the plotting backend failed; check `gold_standard.log` for the mpf errors.

Contributing & Future Work
- Suggested future improvements:
  - Move modules into separate Python files for better testability
  - Add more unit and integration tests (especially for core date boundaries, ADX math, and the strategy prompt)
  - Add a minimal Flask or FastAPI-based view for journal browsing and visual chart rendering
  - Add run-time metrics and Prometheus exporter; containerize the app for easy deployments

Appendices: JSON Schema & Sample
--------------------------------
Memory (`cortex_memory.json`) schema (example):
```json
{
  "history": [
    {
      "timestamp": "2025-11-30T12:34:56",
      "prev_bias": "BULLISH",
      "prev_price": 1940.12,
      "current_price": 1960.55,
      "delta_pct": 1.05,
      "result": "WIN"
    }
  ],
  "win_streak": 2,
  "loss_streak": 0,
  "total_wins": 7,
  "total_losses": 3,
  "last_bias": "BULLISH",
  "last_price_gold": 1930.00,
  "last_update": "2025-11-30T12:34:56"
}
```

Report (`Journal_YYYY-MM-DD.md`) sample (excerpt):
```markdown
# Gold Standard Quant Report

## 1. Algo Self-Correction
* **Previous Call:** BULLISH @ $1930 -> $1960 (+1.55%) = WIN
* **Current Stance:** BULLISH

## 2. Macro & Intermarket
* **Regime:** Trending
* **Gold/Silver Ratio:** 85.2 (Silver cheap)
* **VIX:** 18.4

## 3. Strategic Thesis
* **Bias:** **BULLISH**
* **Logic:** ADX > 25, RSI not overbought, yields falling, etc.

...and charts embedded after the body.
```

---

Additional Educational Booklet: `BOOKLET.md` (Reference section for market indicators and prompt design) — see the compiled booklet in the repo for deep-dive explanations.

---

LICENSE
-------
MIT

---

If you’d like, I’ll now create the `BOOKLET.md` with an in-depth explanation of each technical concept used here (RSI, ATR, ADX, SMA, Gold/Silver ratio, prompt engineering for structured AI output, memory grading logic, and example extension patterns). Let me know if you want a separate folder (`docs/`) or want the booklet to include images and diagrams.

## Git, Pushing Changes & Safety Checklist

Before committing and pushing, perform these checks locally to avoid leaking secrets or committing large artifacts:

1) Ensure git is installed locally:

  PowerShell:
  ```powershell
  git --version
  ```

  Bash/Unix:
  ```bash
  git --version
  ```

2) Ensure the following files are in `.gitignore`: virtualenv, `.env` and `cortex_memory.json`.

3) Run pre-commit hooks:
  ```powershell
  pre-commit run --all-files
  ```
  If you don't have `pre-commit`, install and configure it with `pre-commit install`.

4) Stage, commit and push (PowerShell):
  ```powershell
  .\scripts\git_push.ps1 -Message "chore: update README, BOOKLET, pre-commit & secrets prevention"
  ```

  Or (Bash/Unix):
  ```bash
  ./scripts/git_push.sh "chore: update README, BOOKLET, pre-commit & secrets prevention"
  ```

5) Verify the remote branch and remote exist (`git branch -vv`) and ensure you pushed to the intended remote.

If a secret has been accidentally committed, rotate it immediately and clean history (use `git filter-repo` or remove from history and force push after collaboration discussion).

# Gold Standard

> Quantitative Trading Analysis System

A quantitative analysis system that combines financial market data, technical indicators, and Google Gemini AI to generate trading reports focused on gold and related assets.

## Features

- Multi-Asset Analysis: Gold, Silver, DXY (Dollar Index), US 10Y Yield, VIX, and S&P 500
- Technical Indicators: RSI, ADX, ATR, SMA (50 & 200) via pandas_ta
- Intermarket Correlations: Gold/Silver Ratio analysis and simple divergence detection
- AI-Powered Insights: Uses Google Gemini (configured via google-generativeai) for natural-language analysis
- Self-Reflection Memory: Persists past predictions and grades performance (win/loss/streaks)
- Automated Charts: Generates candlestick charts with SMA overlays (mplfinance)
- Scheduled Execution: Default run every hour (configurable via Config)
- Markdown Reports: Outputs a dated markdown journal per run
- Graceful Shutdown: Ctrl+C (SIGINT) and SIGTERM handled for clean termination
- Structured Logging: Console and file logging (output/gold_standard.log)
- Thread-Safe Memory: FileLock protects cortex_memory.json from concurrent access

## Installation

1. Clone or download this repository.
2. Create a virtual environment and activate it:

    PowerShell (Windows)
    ```powershell
    python -m venv venv
    .\venv\Scripts\Activate.ps1
    ```

    Bash (Linux / macOS)
    ```bash
    python -m venv venv
    source venv/bin/activate
    ```

3. Install dependencies:
    ```bash
    pip install -r requirements.txt
    ```

## Configuration

Set your Gemini API key as an environment variable before running:

PowerShell (Windows)
```powershell
$env:GEMINI_API_KEY = "your-api-key-here"
```

Bash (Linux / macOS)
```bash
export GEMINI_API_KEY="your-api-key-here"
```

Get your API key from Google AI Studio or your Google Cloud/GenAI console.

### Configurable Parameters (defaults reflect main.py)

The `Config` dataclass in main.py exposes these defaults:

- GEMINI_API_KEY: from environment (required)
- GEMINI_MODEL: `models/gemini-pro-latest`
- DATA_PERIOD: `1y`
- DATA_INTERVAL: `1d`
- CHART_CANDLE_COUNT: 100
- MAX_HISTORY_ENTRIES: 5
- MAX_CHART_AGE_DAYS: 7
- ADX_TREND_THRESHOLD: 25.0
- GSR_HIGH_THRESHOLD: 85.0
- GSR_LOW_THRESHOLD: 75.0
- VIX_HIGH_THRESHOLD: 20.0
- RSI_OVERBOUGHT: 70.0
- RSI_OVERSOLD: 30.0
- RUN_INTERVAL_HOURS: 1

Adjust these values directly in main.py or extend the Config class as needed.

## Secrets & Git

This repository includes a `.gitignore` to prevent common local files (virtualenvs, output artifacts, caches) and secret files (`.env`, `cortex_memory.json`) from being committed.

To enforce secret checks and simple formatting hooks, install `pre-commit` and the development dependencies and then register the hooks:

PowerShell (Windows)
```powershell
python -m pip install -r requirements-dev.txt
pre-commit install
pre-commit run --all-files
```

This project includes a local pre-commit hook (`scripts/prevent_secrets.py`) which blocks commits containing `.env` or obvious secret patterns (e.g., API keys or private key blocks). Use `pre-commit` to install and run the hooks automatically before each commit.

If you have accidentally committed secrets in the past, rotate those credentials immediately and remove them from the commit history, e.g., with `git filter-repo` or `git filter-branch`.


## Usage

Run the main program:

```bash
python main.py
```

CLI options:
- `--once`: run one cycle and exit
- `--dry-run`: run without updating memory or writing report
- `--no-ai`: skip AI analysis and produce a simple report
- `--interval <hours>`: override the run interval in hours
- `--log-level <level>`: set log level (DEBUG, INFO, WARNING, ERROR)
- `--gemini-key <key>`: provide Gemini API key via CLI (not recommended; prefer env var)

Example - run once without AI (useful for testing data pipeline):

```bash
python main.py --once --no-ai
```

High-level flow per cycle:

1. Validate GEMINI_API_KEY
2. Fetch market data (yfinance) for tracked assets
3. Compute indicators (RSI, ADX, ATR, SMA50, SMA200)
4. Grade previous prediction using cortex_memory.json
5. Generate charts into output/charts/
6. Query Gemini AI for analysis (google-generativeai)
7. Write a markdown journal to output/Journal_YYYY-MM-DD.md
8. Repeat on schedule (default 4 hours) until shutdown

Press Ctrl+C to shutdown gracefully.

## Output Structure

```
gold_standard/
├── main.py
├── requirements.txt
├── cortex_memory.json       # AI memory with prediction history & win rate
├── cortex_memory.lock       # File lock for concurrent access safety
└── output/
     ├── gold_standard.log    # Application logs
     ├── charts/
     │   ├── GOLD.png
     │   ├── SILVER.png
     │   ├── DXY.png
     │   ├── YIELD.png
     │   ├── VIX.png
     │   └── SPX.png
     └── Journal_YYYY-MM-DD.md
```

Report notes:
- Journal filename is `Journal_YYYY-MM-DD.md` (uses current date).
- The report saved by main.py includes a markdown analysis (AI text) and image links to charts in `charts/`.

## Dependencies

Key packages used (listed in requirements.txt):

- yfinance — market data
- pandas — data manipulation
- pandas_ta — technical indicators (RSI, SMA, ATR, ADX)
- mplfinance — candlestick charting
- google-generativeai — Gemini integration (genai.GenerativeModel)
- schedule — periodic execution
- colorama — terminal coloring
- filelock — thread-safe file locking
Note: The project includes optional dependencies that may require older Python versions (e.g., pandas_ta uses numba). Use Python 3.11 for best compatibility.

Note: Journal output is sanitized to remove emoji characters to maintain plain-text reports.
## Running tests

Install dev/test dependencies then run pytest:

```bash
pip install -r requirements.txt
pytest
```
- (standard library logging, json, datetime, signal, etc.)

## Architecture

The application is implemented in three primary modules inside main.py:

1. Cortex (Memory & Reflection)
    - Loads and persists `cortex_memory.json` under file lock.
    - Records history entries, win/loss streaks, totals, and last bias/price.
    - Grades previous predictions against the current gold price.

2. QuantEngine (Data & Charts)
    - Fetches asset data using yfinance with a primary and backup ticker.
    - Computes RSI, SMA(50/200), ATR, and ADX via pandas_ta.
    - Generates candlestick charts with SMA overlays (mplfinance).
    - Cleans up chart images older than MAX_CHART_AGE_DAYS.

3. Strategist (AI Analysis)
    - Builds an analysis prompt that includes memory, telemetry, ratios, and news.
    - Calls Google Gemini (google-generativeai) to produce natural-language analysis.
    - Extracts a trading bias (BULLISH / BEARISH / NEUTRAL) from the AI response.
    - The configured model is `gemini-1.5-pro-latest`.

## Notes and Implementation Details

- The program validates the GEMINI_API_KEY and configures the GenAI client:
  genai.configure(api_key=...) and model = genai.GenerativeModel(config.GEMINI_MODEL)
- The strategist expects GOLD data; if absent, the cycle aborts.
- Memory grading requires a prior recorded bias and price to compute win/loss.
- Charts and logs are written to the `output/` directory, created automatically.
- The scheduler uses `schedule.every(RUN_INTERVAL_HOURS).hours.do(execute, ...)`.
- File locking with `filelock.FileLock` prevents concurrent memory corruption.

## Sample Memory Template & Initialization
The repository contains a safe-to-commit sample template `cortex_memory.template.json` which stores an empty/default memory schema that doesn't include PII, API keys, or other secrets. This template is meant to make the repository runnable for new contributors while keeping real memory (which contains run-specific values) outside version control.

To initialize a real `cortex_memory.json` from the template you can either run the helper script or let `main.py` auto-populate the memory file on first run.

Manual helper (explicit copy):
```bash
python scripts/init_cortex.py
# or to overwrite if needed
python scripts/init_cortex.py --force
```

Auto-initialization: when `main.py` starts, the `Cortex` class checks for `cortex_memory.json`, and if it is missing, copies `cortex_memory.template.json` to `cortex_memory.json` so long as a template is present. This behavior ensures a consistent, safe starting memory for new users.


## License

MIT
