# Digest Bot â€” Implementation Plan

> Step-by-step roadmap to build, test, and deploy the daily digest summarizer.

---

## Phase 0 â€” Preparation

| Task | Deliverable | Status |
|------|-------------|--------|
| Finalize architecture doc | `docs/ARCHITECTURE.md` | âœ… Done |
| Create plan doc | `docs/PLAN.md` | ðŸ”„ This file |
| Add preliminary README | `README.md` | Pending |

---

## Phase 1 â€” Core Module Scaffold

**Goal:** Establish the package structure and configuration layer.

| File | Purpose |
|------|---------|
| `__init__.py` | Package marker; expose version |
| `__main__.py` | CLI entry: `python -m digest_bot` |
| `config.py` | Load paths, env vars, defaults |

Key config values (via env or `.env`):

| Variable | Default | Description |
|----------|---------|-------------|
| `DIGEST_OUTPUT_DIR` | `output/digests` | Where digests are saved |
| `REPORTS_DIR` | `output/reports` | Base folder for reports |
| `JOURNALS_DIR` | `output/reports/journals` | Daily journal location |
| `PRE_MARKET_DIR` | `output/reports/premarket` | Pre-market plan location |
| `WEEKLY_DIR` | `output/reports/weekly` | Weekly report location |
| `RETRY_INTERVAL_SEC` | `300` | Seconds between gate retries |
| `MAX_RETRIES` | `48` | Max retry attempts before exit |
| `MAX_STALENESS_DAYS` | `1` | Max age for journal/premarket |
| `WEEKLY_LOOKBACK_DAYS` | `14` | Days to look back for weekly report |
| `MIN_FILE_SIZE` | `100` | Minimum bytes to treat as valid |
| `LLM_PROVIDER` | `local` | Provider: `local` (llama.cpp) or `ollama` |
| `LOCAL_LLM_MODEL` | `models/mistral-7b.gguf` | Path to GGUF model file |
| `LOCAL_LLM_GPU_LAYERS` | `0` | GPU layers (0 = CPU only, -1 = all) |
| `OLLAMA_HOST` | `http://localhost:11434` | Ollama server URL |
| `OLLAMA_MODEL` | `mistral` | Ollama model name |

---

## Phase 2 â€” File Gate Logic

**Goal:** Bulletproof input validation with retry loop.

File: `file_gate.py`

Key behaviors (current):
- Strict same-day matching: filename date must equal target date; if frontmatter has `date:`, it must also equal target.
- Candidate files with mismatched filename/frontmatter dates are logged for ops visibility.
- Weekly report uses "latest within lookback" selection (default 14 days).
- Minimum file size enforced to avoid empty/partial files.
- Optional SQLite fallback when files are missing.

Retry loop (simplified):

```
for attempt in range(MAX_RETRIES + 1):
    status = gate.check_all_gates(target)
    if status.should_skip:
        exit(0)  # digest already exists
    if status.all_inputs_ready:
        break
    sleep(RETRY_INTERVAL_SEC)
else:
    exit(1)
```

---

## Phase 3 â€” Summarizer

**Goal:** Call local LLM with curated prompt; return markdown digest.

File: `summarizer.py`

```
class Summarizer:
    def __init__(self, config: Config)
    def build_prompt(pre_market: str, journal: str, weekly: str) -> str
    def call_llm(prompt: str) -> str
    def generate_digest() -> str
```

LLM call strategy:

1. Check `LLM_PROVIDER` env var (default: `local`).
2. **local** (llama.cpp): Load GGUF model via `llama-cpp-python`.
3. **ollama**: POST to `{OLLAMA_HOST}/api/generate` with model name.
4. Retry up to 3 times with exponential backoff (2s, 4s, 8s) on failure.
5. Provider abstraction allows easy swap without code changes.

Prompt constraints:
- Max input tokens: 4096 (truncate weekly if needed).
- Max output tokens: 512.
- Temperature: 0.3 (deterministic).

---

## Phase 4 â€” Writer

**Goal:** Persist digest to disk with metadata.

File: `writer.py`

```
class DigestWriter:
    def __init__(self, config: Config)
    def write(digest_content: str) -> Path
```

Output template:

```markdown
# Daily Digest â€” {date}

{llm_output}

---
_Generated by Digest Bot at {timestamp} UTC_
```

Atomic write: write to `.tmp` then rename to avoid partial files.

---

## Phase 5 â€” CLI & Logging

**Goal:** Usable command-line interface with structured logging.

`__main__.py`:

```
@click.command()
@click.option('--once', is_flag=True, help='Run once without retry loop')
@click.option('--dry-run', is_flag=True, help='Validate gates, skip LLM call')
def main(once, dry_run): ...
```

Logging setup:
- Console: INFO and above.
- File: `output/digests/digest_bot.log`, DEBUG level, rotating.

---

## Phase 6 â€” Testing

| Test | Type | Coverage |
|------|------|----------|
| `test_file_gate.py` | Unit | Gate logic, date parsing, edge cases |
| `test_summarizer.py` | Unit | Prompt building; mock LLM response |
| `test_writer.py` | Unit | Atomic write, template rendering |
| `test_integration.py` | Integration | End-to-end with fixture files |

Fixtures in `tests/fixtures/`:
- Sample pre-market, journal, weekly markdown files.

---

## Phase 7 â€” Deployment

1. **Systemd timer** (`deploy/systemd/syndicate-digest.timer`):
   - Schedule: 17:00 daily (after analysis likely complete).
   - `Persistent=true` to catch up on missed runs.

2. **Service** (`deploy/systemd/syndicate-digest.service`):
   - `ExecStart=python -m digest_bot`
   - `EnvironmentFile` pointing to `.env`.

3. **Cron alternative** (for non-systemd hosts):
   ```
   0 17 * * * cd /path/to/syndicate && .venv/bin/python -m digest_bot >> /var/log/digest_bot.log 2>&1
   ```

---

## Phase 8 â€” Discord AI CLI Bot

**Goal:** Full-featured Discord bot with server management, moderation, and self-refactoring.

### 8.1 Core Bot Setup

| Task | File | Notes |
|------|------|-------|
| Bot lifecycle | `discord/bot.py` | discord.py setup, on_ready, graceful shutdown |
| Config loader | `discord/config.py` | Token, guild ID, channel IDs from env |
| Event router | `discord/events.py` | Message, member, reaction event handlers |

### 8.2 Command Modules

| Module | Commands | Capabilities |
|--------|----------|-------------|
| `commands/digest.py` | `/digest [date]` | Fetch and post digest |
| `commands/structure.py` | `/create-channel`, `/archive`, `/rename` | Structural management |
| `commands/moderation.py` | `/warn`, `/mute`, `/kick`, `/ban`, `/lock` | Mod actions |
| `commands/roles.py` | `/assign-role`, `/temp-role`, `/audit-perms` | Role intelligence |
| `commands/health.py` | `/health`, `/dead-zones`, `/consolidate` | Activity monitoring |
| `commands/knowledge.py` | `/summarize`, `/update-pins`, `/faq` | Knowledge management |

### 8.3 Service Layer

| Service | Purpose |
|---------|--------|
| `services/gate_keeper.py` | Spam/raid detection, rate limiting, auto-escalation |
| `services/activity_tracker.py` | Per-channel engagement metrics, decay detection |
| `services/refactor_engine.py` | Suggest, simulate, apply, rollback structural changes |
| `services/scheduler.py` | Cron-like scheduling for automated tasks |

### 8.4 Self-Refactoring Pipeline

```
1. Analyze server state (channels, activity, roles)
2. Generate recommendations (AI-powered)
3. Simulate changes (dry-run with impact preview)
4. Schedule application (low-activity window)
5. Monitor post-change engagement
6. Auto-rollback if metrics decline
```

### 8.5 Capability Checklist

**ðŸ§± Structural Management**
- [ ] Create / delete channels
- [ ] Create / modify categories
- [ ] Rename channels based on usage
- [ ] Archive dead channels
- [ ] Reorder server layout
- [ ] Enforce naming conventions

**ðŸ›¡ Moderation & Hygiene**
- [ ] Detect spam / raids
- [ ] Auto-timeout / kick / ban
- [ ] Escalation logic
- [ ] Lock threads
- [ ] Enforce slow-mode dynamically

**ðŸ‘¥ Role & Permission Intelligence**
- [ ] Auto-assign roles based on behavior
- [ ] Adjust permissions dynamically
- [ ] Detect privilege abuse
- [ ] Create temporary roles

**ðŸ“Š Activity & Health Monitoring**
- [ ] Track engagement decay
- [ ] Detect dead zones
- [ ] Recommend consolidation
- [ ] Generate weekly health reports

**ðŸ§  Knowledge & Memory**
- [ ] Summarize channels
- [ ] Maintain living docs
- [ ] Auto-update pinned messages
- [ ] Detect repeated questions

**ðŸ”„ Self-Refactoring**
- [ ] Suggest structural changes
- [ ] Simulate changes before applying
- [ ] Apply during low-activity windows
- [ ] Roll back if engagement drops

### 8.6 Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `DISCORD_BOT_TOKEN` | Yes | Bot authentication token |
| `DISCORD_GUILD_ID` | Yes | Target server ID |
| `DISCORD_DIGEST_CHANNEL_ID` | No | Channel for digest posts |
| `DISCORD_LOG_CHANNEL_ID` | No | Channel for bot action logs |
| `DISCORD_ADMIN_ROLE_ID` | No | Role that can manage bot |
| `DISCORD_AUTO_REFACTOR` | No | Enable self-refactoring (default: false) |

---

## Milestones & Timeline

| Milestone | Target |
|-----------|--------|
| Phase 1-2 (scaffold + gates) | Day 1 |
| Phase 3-4 (summarizer + writer) | Day 2 |
| Phase 5-6 (CLI + tests) | Day 3 |
| Phase 7 (deploy) | Day 4 |
| Phase 8.1-8.2 (Discord core + commands) | Week 2 |
| Phase 8.3-8.4 (services + self-refactoring) | Week 3 |
| Phase 8.5-8.6 (full capability rollout) | Week 4 |

---

## Open Questions

1. Should digest be posted to Notion as well? (Reuse existing publisher)
2. Preferred local model size? (7B recommended for speed; 13B for quality)
3. Self-refactoring: require admin approval or fully autonomous?
4. Discord rate limits: batch structural changes or spread over time?
5. Rollback window: how long to monitor before reverting?

---

_Last updated: 2025-12-15_
